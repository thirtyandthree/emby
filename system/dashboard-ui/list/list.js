define(["exports","./../modules/emby-apiclient/connectionmanager.js","./../modules/emby-apiclient/events.js","./../modules/common/globalize.js","./../modules/common/playback/playbackmanager.js","./../modules/appheader/appheader.js","./../modules/backdrop/backdrop.js","./../modules/common/itemmanager/itemmanager.js","./../modules/layoutmanager.js","./../modules/common/usersettings/usersettings.js","./../modules/viewmanager/baseview.js","./../search/searchfields.js","./../modules/emby-elements/emby-scroller/emby-scroller.js","./../modules/emby-elements/emby-tabs/emby-tabs.js","./../modules/emby-elements/emby-itemscontainer/emby-itemscontainer.js","./../modules/tabbedview/listcontroller.js"],function(_exports,_connectionmanager,_events,_globalize,_playbackmanager,_appheader,_backdrop,_itemmanager,_layoutmanager,_usersettings,_baseview,_searchfields,_embyScroller,_embyTabs,_embyItemscontainer,_listcontroller){function hideOrShowAll(elems,hide){for(var i=0,length=elems.length;i<length;i++)hide?elems[i].classList.add("hide"):elems[i].classList.remove("hide")}function ItemsView(view,params){_baseview.default.apply(this,arguments),_listcontroller.default.apply(this,arguments);var _document$querySelect;this.params=params,null==this.supportsViewSettings&&(this.supportsViewSettings="downloads"!==params.parentId&&"search"!==params.type),null==this.enableTotalRecordCountDisplay&&(this.enableTotalRecordCountDisplay="search"!==params.type),this.initItemsContainer(),params.parentId?this.itemsContainer.setAttribute("data-parentid",params.parentId):"nextup"===params.type?this.itemsContainer.setAttribute("data-monitor","videoplayback"):"favoritemovies"===params.type?this.itemsContainer.setAttribute("data-monitor","markfavorite"):"Program"!==params.type&&"OnNow"!==params.type&&"TvChannel"!==params.type||this.itemsContainer.setAttribute("data-refreshinterval","300000"),"search"===params.type&&(view.querySelector(".searchContainer").classList.remove("hide"),_document$querySelect=_layoutmanager.default.tv?null:null==(_document$querySelect=document.querySelector(".txtNavDrawerSearch "))?void 0:_document$querySelect.value,_document$querySelect=params.query||_document$querySelect,this.searchFields=new _searchfields.default({element:view.querySelector(".searchFields"),serverId:this.getApiClient().serverId(),value:_document$querySelect,autoFocus:!_document$querySelect}),_events.default.on(this.searchFields,"search",function(e,value){var activeSearchTab=this.view.querySelector(".emby-searchable-tab-button.emby-tab-button-active");activeSearchTab&&activeSearchTab.classList.remove("emby-searchable-tab-button"),this.itemsContainer.refreshItems()}.bind(this))),this.initButtons()}function dispatchItemShowEvent(view,eventName,item){view.dispatchEvent(new CustomEvent(eventName,{detail:{item:item},bubbles:!0,cancelable:!1}))}function isNotName(n){return"Name"!==n}function isNotAirTime(n){return"AirTime"!==n}function isNotParentName(n){return"ParentName"!==n}function adjustListOptionsForGroupingProgramsBySeries(instance,items,options){"search"!==instance.params.type&&items.length&&items[0].AsSeries&&(options.progress=!1,options.showAirDateTime=!1,options.fields=options.fields.filter(isNotName).filter(isNotAirTime).filter(isNotParentName),options.fields.push("ParentNameOrName"))}function getTopLevelDownloadFolders(apiClient){return apiClient.getLocalFolders()}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Object.assign(ItemsView.prototype,_baseview.default.prototype),Object.assign(ItemsView.prototype,_listcontroller.default.prototype),ItemsView.prototype.onInputCommand=function(e){switch(e.detail.command){case"refresh":return this.itemsContainer.refreshItems(),e.preventDefault(),void e.stopPropagation();case"search":var _e$detail$originalEve;if(this.searchFields)return null!=(_e$detail$originalEve=e.detail.originalEvent)&&_e$detail$originalEve.target.closest(".txtNavDrawerSearch")?this.searchFields.setSearchTerm((null==(_e$detail$originalEve=e.detail.commandOptions)?void 0:_e$detail$originalEve.value)||""):(console.log("focusing search fields"),this.searchFields.focus()),e.preventDefault(),void e.stopPropagation()}_baseview.default.prototype.onInputCommand.apply(this,arguments)},ItemsView.prototype.getTitle=function(){var params=this.params;return"search"===params.type?_globalize.default.translate("Search"):"downloads"===params.parentId?_globalize.default.translate("Downloads"):"Recordings"===params.type?_globalize.default.translate("Recordings"):"OnNow"===params.type?_globalize.default.translate("HeaderOnNow"):"Program"===params.type?"true"===params.IsMovie?_globalize.default.translate("Movies"):"true"===params.IsSports?_globalize.default.translate("Sports"):"true"===params.IsKids?_globalize.default.translate("HeaderForKids"):"true"===params.IsAiring?_globalize.default.translate("HeaderOnNow"):"true"===params.IsSeries?params.IsNewOrPremiere?_globalize.default.translate("TitleNewEpisodes"):_globalize.default.translate("Shows"):"true"===params.IsNews?_globalize.default.translate("News"):_globalize.default.translate("Program"):"nextup"===params.type?_globalize.default.translate("HeaderNextUp"):"favoritemovies"===params.type?_globalize.default.translate("FavoriteMovies"):this.currentItem||("Movie"===params.type?_globalize.default.translate("Movies"):"Series"===params.type?_globalize.default.translate("Shows"):"Season"===params.type?_globalize.default.translate("Seasons"):"Episode"===params.type?_globalize.default.translate("Episodes"):"MusicArtist"===params.type?_globalize.default.translate("Artists"):"MusicAlbum"===params.type?_globalize.default.translate("Albums"):"Audio"===params.type?_globalize.default.translate("Songs"):"Game"===params.type?_globalize.default.translate("Games"):"Video"===params.type?_globalize.default.translate("Videos"):void 0)},ItemsView.prototype.getItem=function(){var apiClient,params=this.params;return"Recordings"!==params.type&&"Program"!==params.type&&"nextup"!==params.type&&"search"!==params.type&&"OnNow"!==params.type&&params.serverId&&(apiClient=this.getApiClient(),params=params.genreId||params.gameGenreId||params.musicGenreId||params.studioId||params.tagId||params.artistId||params.albumArtistId||params.personId||params.parentId)&&"downloads"!==params?apiClient.getItem(apiClient.getCurrentUserId(),params):Promise.resolve(null)},ItemsView.prototype.onItemRefreshed=function(item){item?(_backdrop.default.setBackdrops([item]),dispatchItemShowEvent(this.view,"itemshow",item)):(_backdrop.default.clear(),dispatchItemShowEvent(this.view,"itemclear",item)),this.setTitle()},ItemsView.prototype.onResume=function(options){_baseview.default.prototype.onResume.apply(this,arguments),_listcontroller.default.prototype.resume.apply(this,arguments);var alphaNumericShortcuts=this.alphaNumericShortcuts,refresh=(alphaNumericShortcuts&&alphaNumericShortcuts.resume(),options.refresh),instance=(this.setTitle(),this);this.getItem().then(function(item){instance.currentItem=item,instance.onItemRefreshed(item),instance.updateSortText(),instance.itemsContainer.resume({refresh:refresh}).then(function(){var searchFields=instance.searchFields;searchFields&&searchFields.resume({refresh:refresh}),refresh&&instance.autoFocus()}),instance.alphaPicker||instance.supportsAlphaPicker()&&instance.initAlphaPicker();item=instance.view;instance.supportsPlay()?hideOrShowAll(item.querySelectorAll(".btnPlay"),!1):hideOrShowAll(item.querySelectorAll(".btnPlay"),!0),instance.supportsShuffle()?hideOrShowAll(item.querySelectorAll(".btnShuffle"),!1):hideOrShowAll(item.querySelectorAll(".btnShuffle"),!0),instance.supportsQueue()?hideOrShowAll(item.querySelectorAll(".btnQueue"),!1):hideOrShowAll(item.querySelectorAll(".btnQueue"),!0)})},ItemsView.prototype.onPause=function(){_baseview.default.prototype.onPause.apply(this,arguments);var searchFields=this.searchFields;searchFields&&searchFields.pause(),_listcontroller.default.prototype.pause.apply(this,arguments)},ItemsView.prototype.destroy=function(){_baseview.default.prototype.destroy.apply(this,arguments),_listcontroller.default.prototype.destroy.apply(this,arguments),this.searchFields&&(this.searchFields.destroy(),this.searchFields=null),this.currentItem=null},ItemsView.prototype.getContext=function(){return this.params.context},ItemsView.prototype.getCardOptions=function(items,settings){var preferLogo,defaultShape,preferThumb,preferDisc,params=this.params,showParentTitle=!1,settings=("banner"===settings.imageType?shape="banner":"disc"===settings.imageType?(shape="square",preferDisc=!0):"logo"===settings.imageType?(shape="backdrop",preferLogo=!0):"thumb"===settings.imageType?(shape="backdrop",preferThumb=!0):"nextup"===params.type?(shape="backdrop",preferThumb="thumb"===settings.imageType):"Program"===params.type||"OnNow"===params.type||"Recordings"===params.type?(preferThumb=shape="auto",defaultShape="true"===params.IsMovie||"OnNow"===params.type?"portrait":"backdrop"):shape="auto",settings.fields),shape=Object.assign(this.getBaseListRendererOptions(items),{shape:shape,preferThumb:preferThumb,preferDisc:preferDisc,preferLogo:preferLogo,overlayPlayButton:!1,defaultShape:defaultShape,cardSize:this.getViewSettings().cardSize});return"Audio"===params.type&&(shape.action="playallfromhere"),"Person"===params.type?showParentTitle=!1:"Audio"===params.type?(showParentTitle=settings.includes("Name"),shape.sideFooter=!0):"MusicAlbum"===params.type||"Episode"===params.type||"Game"===params.type||params.gameGenreId?showParentTitle=settings.includes("Name"):"MusicArtist"===params.type?shape.round=!0:"Program"===params.type?(showParentTitle=settings.includes("Name")&&"true"!==params.IsMovie,(preferThumb=settings.includes("Name")&&"Recordings"!==params.type)&&settings.push("AirTime"),shape=Object.assign(shape,{inheritThumb:"Recordings"===params.type,context:"livetv",showAirDateTime:preferThumb,overlayPlayButton:!1})):"OnNow"===params.type?(showParentTitle=!1,shape=Object.assign(shape,{programsAsSeries:!0,action:"programlink",showCurrentProgramImage:!0}),settings.includes("Name")&&(settings.unshift("CurrentProgramParentName"),settings.unshift("CurrentProgramName"),settings.push("CurrentProgramTime"))):"TvChannel"===params.type?settings.includes("Name")&&(settings.unshift("CurrentProgramParentName"),settings.push("CurrentProgramTime")):showParentTitle=params.type&&settings.includes("Name"),showParentTitle&&settings.push("ParentName"),"search"===params.type&&(preferDisc=this.view.querySelector(".emby-searchable-tab-button.emby-tab-button-active"))&&"MusicArtist"===preferDisc.getAttribute("data-searchtype")&&(shape.round=!0),settings=Array.from(new Set(settings)),shape.fields=settings,shape.overlayText=0===settings.length||"None"===settings[0],adjustListOptionsForGroupingProgramsBySeries(this,items,shape),shape.context=this.getContext(),shape.typeIndicator="folders"===shape.context,shape},ItemsView.prototype.getListViewOptions=function(items,settings){var options=_listcontroller.default.prototype.getListViewOptions.apply(this,arguments),params=this.params,showParentTitle=!1,visibleFields=options.fields;return"Audio"===params.type||"MusicAlbum"===params.type||"Episode"===params.type||"Game"===params.type||params.gameGenreId?showParentTitle=visibleFields.includes("Name"):"MusicArtist"===params.type?options.round=!0:"Program"===params.type?(showParentTitle=visibleFields.includes("Name")&&"true"!==params.IsMovie,visibleFields.includes("Name")&&"Recordings"!==params.type&&visibleFields.push("AirTime")):"OnNow"===params.type?visibleFields.includes("Name")&&(visibleFields.unshift("CurrentProgramParentName"),visibleFields.unshift("CurrentProgramName"),visibleFields.push("CurrentProgramTime")):"TvChannel"===params.type?visibleFields.includes("Name")&&(visibleFields.unshift("CurrentProgramParentName"),visibleFields.push("CurrentProgramTime")):showParentTitle=params.type&&visibleFields.includes("Name"),showParentTitle&&visibleFields.push("ParentName"),visibleFields=Array.from(new Set(visibleFields)),options.fields=visibleFields,"OnNow"===params.type&&(options.programsAsSeries=!0,options.action="programlink",options.showCurrentProgramImage=!0),"search"===params.type&&(options.imageSize="small"),adjustListOptionsForGroupingProgramsBySeries(this,items,options),options},ItemsView.prototype.supportsAlphaPicker=function(){var item=this.currentItem;return item?"PhotoAlbum"!==item.Type:_listcontroller.default.prototype.supportsAlphaPicker.apply(this,arguments)},ItemsView.prototype.getCommandOptions=function(){var options=_listcontroller.default.prototype.getCommandOptions.apply(this,arguments);return options.removeFromNextUp="nextup"===this.params.type,options.createRecording="OnNow"!==this.params.type,options},ItemsView.prototype.getItems=function(initialQuery,signal){return"downloads"===this.params.parentId?Promise.all(_connectionmanager.default.getApiClients().map(getTopLevelDownloadFolders)).then(function(responses){for(var list=[],i=0,length=responses.length;i<length;i++)list=list.concat(responses[i]);return list}):_listcontroller.default.prototype.getItems.apply(this,arguments)},ItemsView.prototype.getApiClientQueryMethodName=function(){var params=this.params;return"MusicArtist"===params.type?"getArtists":"Person"===params.type?"getPeople":"Recordings"===params.type?"getLiveTvRecordings":"OnNow"===params.type?"getLiveTvChannels":"nextup"===params.type?"getNextUpEpisodes":_listcontroller.default.prototype.getApiClientQueryMethodName.apply(this,arguments)},ItemsView.prototype.getPrefixes=function(){return"downloads"===this.params.parentId?Promise.resolve([]):_listcontroller.default.prototype.getPrefixes.apply(this,arguments)},ItemsView.prototype.getPrefixesApiClientMethodName=function(){return"MusicArtist"===this.params.type?"getArtistPrefixes":_listcontroller.default.prototype.getPrefixesApiClientMethodName.apply(this,arguments)},ItemsView.prototype.getPrefixQueryIncludeItemTypes=function(){return"MusicArtist"===this.params.type?[]:_listcontroller.default.prototype.getPrefixQueryIncludeItemTypes.apply(this,arguments)},ItemsView.prototype.getQueryIncludeItemTypes=function(){var params=this.params;if(params.musicGenreId)return(type=params.type||null)?[type]:["MusicAlbum","MusicVideo"];if(params.gameGenreId)return["Game"];if(params.genreId)return(type=params.type||null)?[type]:["Movie","Series","Video","Game","MusicAlbum"];if(params.personId)return(type=params.type||null)?[type]:[];if(params.studioId)return["Movie","Series","Video","Game"];var _type3,type=this.currentItem;if(type){if("MusicGenre"===type.Type)return["MusicAlbum","MusicVideo"];if("GameGenre"===type.Type)return["Game"];if("Genre"===type.Type)return["Movie","Series","Video"];if("Person"===type.Type)return(_type3=params.type||null)?[_type3]:[];if("Studio"===type.Type)return["Movie","Series","Video","Game"];if("movies"===type.CollectionType)return["Movie"];if("tvshows"===type.CollectionType)return["Series"]}return"MusicArtist"===params.type||"Person"===params.type||"search"===params.type||"OnNow"===params.type?[]:_listcontroller.default.prototype.getQueryIncludeItemTypes.apply(this,arguments)},ItemsView.prototype.saveSortingOnServer=function(){return"OnNow"!==this.params.type&&_listcontroller.default.prototype.saveSortingOnServer.apply(this,arguments)},ItemsView.prototype.refreshSearchTabs=function(tabs){tabs.length&&tabs.unshift({Name:_globalize.default.translate("HeaderTopResults"),Id:"all"}),1<tabs.length&&(html=(html='<div is="emby-tabs" class="searchTabsContainer searchFieldsBottomBorder padded-bottom focuscontainer-x"><div class="emby-tabs-slider scrollSliderX padded-top-focusscale padded-bottom-focusscale padded-left padded-left-page padded-right searchTabsScroller">')+tabs.map(function(tab,index){var pluralName="all"===tab.Id?tab.Name:_itemmanager.default.getPluralItemTypeName(tab.Name);return'<button type="button" is="emby-button" class="emby-searchable-tab-button secondaryText emby-search-tab-button emby-tab-button emby-button" data-searchtype="'+(tab.Id||tab.Name)+'" data-index="'+index+'">'+pluralName+"</button>"}).join("")+"</div></div>");var html,tabs=this.view.querySelector(".searchTabs");(tabs.innerHTML=html)?(tabs.classList.remove("hide"),tabs.querySelector(".searchTabsContainer").addEventListener("tabchange",function(){this.itemsContainer.refreshItems()}.bind(this))):tabs.classList.add("hide")},ItemsView.prototype.setTitle=function(){var title;!1!==this.params.setTitle&&(title=this.getTitle(),_appheader.default.setTitle(title||""))},ItemsView.prototype.getSortBySettingsKey=function(sortMenuOptions){return"OnNow"===this.params.type?_usersettings.default.getLiveTvChannelSortSettingsKey():_listcontroller.default.prototype.getSortBySettingsKey.apply(this,arguments)},ItemsView.prototype.getSortByValue=function(){var query;return"OnNow"===this.params.type?(_usersettings.default.addLiveTvChannelSortingToQuery(query={},_globalize.default),query.SortBy):_listcontroller.default.prototype.getSortByValue.apply(this,arguments)},ItemsView.prototype.getDefaultSorting=function(){var query;return"OnNow"===this.params.type?(_usersettings.default.addLiveTvChannelSortingToQuery(query={},_globalize.default),{sortBy:query.SortBy,sortOrder:query.SortOrder}):_listcontroller.default.prototype.getDefaultSorting.apply(this,arguments)},ItemsView.prototype.supportsPlay=function(){var params=this.params,currentItem=this.currentItem,currentItem=null==currentItem?void 0:currentItem.CollectionType;return"downloads"!==params.parentId&&"search"!==params.type&&"playlists"!==currentItem&&"boxsets"!==currentItem&&_listcontroller.default.prototype.supportsPlay.apply(this,arguments)},ItemsView.prototype.supportsShuffle=function(){var params=this.params,currentItem=this.currentItem,itemType=null==currentItem?void 0:currentItem.Type,currentItem=null==currentItem?void 0:currentItem.CollectionType;return"downloads"!==params.parentId&&"search"!==params.type&&"playlists"!==currentItem&&"boxsets"!==currentItem&&("MusicGenre"===itemType||"Program"!==params.type&&"TvChannel"!==params.type&&"OnNow"!==params.type&&"nextup"!==params.type&&"Game"!==params.type&&"Channel"!==itemType&&"GameSystem"!==itemType&&"GameGenre"!==itemType)&&this.supportsPlay()},ItemsView.prototype.supportsQueue=function(){var params=this.params,currentItem=this.currentItem,currentItem=null==currentItem?void 0:currentItem.CollectionType;if("downloads"!==params.parentId&&"search"!==params.type&&"playlists"!==currentItem&&"boxsets"!==currentItem&&this.supportsPlay()){params=this.currentItem;if(params)return _playbackmanager.default.canQueue(params)}return!1},ItemsView.prototype.getSortMenuOptions=function(){var params=this.params;return"OnNow"===params.type?_usersettings.default.getLiveTvChannelSortOrders(_globalize.default):"downloads"===params.parentId||"nextup"===params.type||"search"===params.type?[]:_listcontroller.default.prototype.getSortMenuOptions.apply(this,arguments)},ItemsView.prototype.showFilterMenu=function(){var instance=this,params=instance.params,query={},item=(params.genreId&&(query.GenreIds=params.genreId),instance.currentItem);item&&("Studio"===item.Type?query.StudioIds=item.Id:"Tag"===item.Type?query.TagIds=item.Id:"Genre"===item.Type||"GameGenre"===item.Type||"MusicGenre"===item.Type?query.GenreIds=item.Id:"Person"===item.Type&&(query.PersonIds=item.Id)),params.artistId&&(query.ArtistIds=params.artistId),params.albumArtistId&&(query.AlbumArtistIds=params.albumArtistId),Emby.importModule("./modules/filtermenu/filtermenu.js").then(function(FilterMenu){(new FilterMenu).show(Object.assign(query,{settingsKey:instance.getSettingsKey(),settings:instance.getFilters(),visibleSettings:instance.getVisibleFilters(),onChange:instance.itemsContainer.refreshItems.bind(instance.itemsContainer),parentId:instance.params.parentId,itemTypes:instance.getItemTypes(),serverId:instance.params.serverId,filterMenuOptions:instance.getFilterMenuOptions()})).then(function(){instance.itemsContainer.refreshItems()})})},ItemsView.prototype.getVisibleFilters=function(){var params=this.params;return"downloads"===params.parentId||"nextup"===params.type||"OnNow"===params.type||"search"===params.type?[]:_listcontroller.default.prototype.getVisibleFilters.apply(this,arguments)},ItemsView.prototype.getFilterMenuOptions=function(){var params=this.params;return{IsAiring:params.IsAiring,IsMovie:params.IsMovie,IsSports:params.IsSports,IsKids:params.IsKids,IsNews:params.IsNews,IsSeries:params.IsSeries,Recursive:this.getQueryInfo(!1).Recursive}},ItemsView.prototype.getDisplayPreset=function(){var params=this.params;if(params.mediaTypes)return params.mediaTypes.split(",")[0];params=this.currentItem;if(params)switch(params.CollectionType){case"playlists":return"Playlist";case"boxsets":return"BoxSet"}return _listcontroller.default.prototype.getDisplayPreset.apply(this,arguments)},ItemsView.prototype.getViewSettingDefaults=function(currentItem,listItems,availableFieldIds){var activeSearchTab,defaults=_listcontroller.default.prototype.getViewSettingDefaults.apply(this,arguments),params=this.params;return"search"===params.type?(defaults.fields=["Name"],!(activeSearchTab=this.view.querySelector(".emby-searchable-tab-button.emby-tab-button-active"))||"all"===(activeSearchTab=activeSearchTab.getAttribute("data-searchtype"))?(defaults.fields.push("Type"),defaults.fields.push("ProductionYear")):"Movie"===activeSearchTab||"Series"===activeSearchTab||"Trailer"===activeSearchTab?defaults.fields.push("ProductionYear"):"Audio"===activeSearchTab&&(defaults.imageType="list")):"nextup"===params.type&&(defaults.imageType=this.params.defaultView||"thumb"),defaults},ItemsView.prototype.getItemTypes=function(){var params=this.params;return"nextup"===params.type?["Episode"]:"Recordings"===params.type?["Episode","Video","Movie"]:"search"===params.type?[]:"favoritemovies"===params.type?["Movie"]:"OnNow"===params.type?["TvChannel"]:params.type?params.type.split(","):[]},ItemsView.prototype.getSettingsKey=function(){var values=[],params=(values.push("items"),this.params);return params.type?values.push(params.type):params.mediaTypes?values.push(params.mediaTypes):params.parentId&&values.push(params.parentId),params.IsAiring&&values.push("IsAiring"),params.IsMovie&&values.push("IsMovie"),params.IsKids&&values.push("IsKids"),params.IsSports&&values.push("IsSports"),params.IsNews&&values.push("IsNews"),params.IsSeries&&values.push("IsSeries"),params.IsFavorite&&values.push("IsFavorite"),params.genreId&&values.push("Genre"),params.gameGenreId&&values.push("GameGenre"),params.musicGenreId&&values.push("MusicGenre"),params.studioId&&values.push("Studio"),params.tagId&&values.push("Tag"),params.personId&&values.push("Person"),params.parentId&&values.push("Folder"),values.join("-")};_exports.default=ItemsView});