define(["exports","./../dom.js","./../layoutmanager.js","./../backdrop/backdrop.js","./../shortcuts.js","./../common/usersettings/usersettings.js","./../common/itemmanager/itemmanager.js","./../mediainfo/mediainfo.js","./../skinmanager.js","./../emby-apiclient/connectionmanager.js","./../common/globalize.js","./../focusmanager.js","./../maintabsmanager.js"],function(_exports,_dom,_layoutmanager,_backdrop,_shortcuts,_usersettings,_itemmanager,_mediainfo,_skinmanager,_connectionmanager,_globalize,_focusmanager,_maintabsmanager){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;var decodingAttribute=_dom.default.supportsAsyncDecodedImages()?' decoding="async"':"";function BaseTab(view,params){this.scroller=view.querySelector(".scrollFrameY"),this.view=view,this.params=params,this.requestedItemFields="BasicSyncInfo,CanDelete"}function clearSelectedInfoTimer(instance){var selectedItemInfoTimeout=instance.selectedItemInfoTimeout;selectedItemInfoTimeout&&(clearTimeout(selectedItemInfoTimeout),instance.selectedItemInfoTimeout=null)}function startSelectedInfoTimer(instance){clearSelectedInfoTimer(instance),instance.selectedItemInfoTimeout=setTimeout(function(){var focused;this.paused||(focused=this._focusedElement)&&(focused=_shortcuts.default.getItemFromChildNode(focused,!0),this.onItemFocused(focused),focused)&&focused.ServerId&&this._enableBackdrops&&_backdrop.default.setBackdrop(focused)}.bind(instance),500)}var backgroundContainer=document.querySelector(".backgroundContainer"),backdropContainer=document.querySelector(".backdropContainer");function fillFocusPreview(instance,elem,item){item=item.CurrentProgram||item,_backdrop.default.setBackdrop(item);var focusPreviewTitle=elem.querySelector(".focusPreviewTitle"),focusPreviewSecondaryTitle=elem.querySelector(".focusPreviewSecondaryTitle"),names=[],apiClient=_connectionmanager.default.getApiClient(item),itemForTitle="Timer"===item.Type&&item.ProgramInfo||item,itemForTitle="title"!==function(item){return"TvChannel"===item.Type?null:("MusicAlbum"!==item.Type&&"Audio"!==item.Type&&"MusicVideo"!==item.Type||item.ImageTags&&item.ImageTags.Logo)&&_usersettings.default.getEnableLogoAsTitle(_globalize.default.getCurrentLocale())?"title":"float"}(itemForTitle)?null:function(item,apiClient,options){options=options||{};var logoTypes=_skinmanager.default.getPreferredLogoImageTypes();return apiClient.getLogoImageUrl(item,options,logoTypes)}(itemForTitle,apiClient,{maxHeight:120}),itemForTitle=(item.SeriesName&&(apiClient=item.SeriesName,itemForTitle&&(apiClient='<img draggable="false" loading="lazy"'+decodingAttribute+' class="focusPreviewTitleImg" alt="'+apiClient+'" src="'+itemForTitle+'" />',itemForTitle=null),names.push(apiClient)),item.Name&&(item.EpisodeTitle||item.IsSeries)&&(apiClient=item.Name,itemForTitle&&(apiClient='<img draggable="false" loading="lazy"'+decodingAttribute+' class="focusPreviewTitleImg" alt="'+apiClient+'" src="'+itemForTitle+'" />',itemForTitle=null),names.push(apiClient)),item.Name&&(apiClient=_itemmanager.default.getDisplayName(item,{}),itemForTitle&&(apiClient='<img draggable="false" loading="lazy"'+decodingAttribute+' class="focusPreviewTitleImg" alt="'+apiClient+'" src="'+itemForTitle+'" />',itemForTitle=null),names.push(apiClient)),focusPreviewTitle.innerHTML=names[0]||"",1<names.length?(focusPreviewSecondaryTitle.innerHTML=names[1]||"",focusPreviewSecondaryTitle.classList.remove("hide")):focusPreviewSecondaryTitle.classList.add("hide"),elem.querySelector(".focusPreviewMediaInfo")),apiClient="Program"===item.Type?_mediainfo.default.getSecondaryMediaInfoHtml(item):_mediainfo.default.getPrimaryMediaInfoHtml(item);itemForTitle.innerHTML=apiClient,elem.querySelector(".focusPreviewOverview").innerHTML=item.Overview||"",elem.classList.remove("hide")}function fillWithRandomItem(instance,elem,item){var apiClient=_connectionmanager.default.getApiClient(item),itemTypes="Movie,Series,Game,MusicAlbum,MusicArtist,Trailer";switch(item.CollectionType){case"movies":itemTypes="Movie";break;case"tvshows":itemTypes="Series";break;case"games":itemTypes="Game";break;case"musicvideos":itemTypes="MusicVideo";break;case"homevideos":itemTypes="Video";break;case"music":case"audiobooks":itemTypes="MusicAlbum,MusicArtist"}!function(instance,apiClient,types,parentId){return types={SortBy:"Random",Limit:1,Recursive:!0,IncludeItemTypes:types,ImageTypes:"Backdrop",ParentId:parentId,EnableTotalRecordCount:!1,ImageTypeLimit:1,Fields:instance.getRequestedItemFields(),EnableImageTypes:instance.getRequestedImageTypes()+",Backdrop"},apiClient.getItems(apiClient.getCurrentUserId(),types)}(instance,apiClient,itemTypes,item.Id).then(function(result){fillFocusPreview(0,elem,result.Items[0]||item)})}function getScrollerNavOutDestination(direction){return direction===_focusmanager.default.directions.up?document.querySelector(".skinHeader"):null}BaseTab.prototype.supportsFocusPreview=function(){return!1},BaseTab.prototype.enableFocusPreview=function(){return _layoutmanager.default.tv&&this.supportsFocusPreview()&&_usersettings.default.enableHomescreenFocusPreviews()},BaseTab.prototype.getFocusPreviewElement=function(){var elem=this._focusPreviewElement;return elem||(this.view.insertAdjacentHTML("afterbegin",'<div class="padded-top-page padded-left padded-right focusPreviewContainer hide">\n        <div class="readOnlyContent" style="padding:0 .75em;width:40ch;border-box;">\n            <h1 style="margin:0;" class="focusPreviewTitle"></h1>\n            <h3 class="focusPreviewSecondaryTitle hide" style="margin:0;"></h3>\n            <div class="secondaryText focusPreviewMediaInfo mediaInfoItems" style="margin:.1em 0;font-size:92%;"></div>\n            <div class="secondaryText focusPreviewOverview" style="margin:.25em 0 0;"></div>\n        </div></div>\n'),this._focusPreviewElement=elem=this.view.querySelector(".focusPreviewContainer")),elem},BaseTab.prototype.autoFocus=function(options){options=Object.assign({skipIfNotEnabled:!0},options);var elem,view=this.view;return view&&(elem=_focusmanager.default.autoFocus(view,options))?elem:(!options.skipIfNotEnabled||_focusmanager.default.isAutoFocusEnabled())&&(elem=_maintabsmanager.default.focus())||null},BaseTab.prototype.showFocusPreview=function(item){var elem=this.getFocusPreviewElement(item);if(item)switch(item.Type){case"Channel":case"CollectionFolder":fillWithRandomItem(this,elem,item);break;default:fillFocusPreview(0,elem,item)}else elem.classList.add("hide")},BaseTab.prototype.onItemFocused=function(item){this.enableFocusPreview()&&this.showFocusPreview(item)},BaseTab.prototype.onFocusOut=function(){},BaseTab.prototype.fillFocusPreviewIfNeeded=function(){if(this.enableFocusPreview()){var elem=document.activeElement||document.body;if(this.view.contains(elem)){var itemsContainer=elem.closest(".itemsContainer");if(itemsContainer&&elem.matches(itemsContainer.getItemSelector()))return}(elem=this.view.querySelector(".card"))&&(itemsContainer=elem.closest(".itemsContainer"))&&(itemsContainer=itemsContainer.getItemFromElement(elem),this.showFocusPreview(itemsContainer))}},BaseTab.prototype.getRequestedItemFields=function(){var fields=this.requestedItemFields;return(this.enableFocusPreview()||this.hasSelectedItemDisplay())&&(fields+=",Overview,CommunityRating,CriticRating,OfficialRating,PremiereDate,ProductionYear,Container"),fields},BaseTab.prototype.getRequestedImageTypes=function(){var fields="Primary,Backdrop,Thumb";return(this.enableFocusPreview()||this.hasSelectedItemDisplay())&&(fields+=",Logo"),fields},BaseTab.prototype.enableBackdropsOnFocus=function(){return!!this.enableFocusPreview()||_usersettings.default.enableBackdrops()},BaseTab.prototype.addFocusBehavior=function(element){this._enableBackdrops=_layoutmanager.default.tv&&this.enableBackdropsOnFocus(),(this._enableBackdrops||_layoutmanager.default.tv&&this.hasSelectedItemDisplay())&&(this.boundonItemsContainerFocusIn||(this.boundonItemsContainerFocusIn=function(e){e=e.target,(this._focusedElement=e)&&startSelectedInfoTimer(this)}.bind(this)),this.boundonItemsContainerFocusOut||(this.boundonItemsContainerFocusOut=function(e){clearSelectedInfoTimer(this),this.onFocusOut()}.bind(this)),_dom.default.addEventListener(element,"focus",this.boundonItemsContainerFocusIn,{capture:!0,passive:!0}),_dom.default.addEventListener(element,"focusout",this.boundonItemsContainerFocusOut,{passive:!0}))},BaseTab.prototype.hasSelectedItemDisplay=function(){return!1},BaseTab.prototype.hasFocus=function(){var activeElement=document.activeElement,view=this.view;return activeElement&&view&&view.contains(activeElement)},BaseTab.prototype.scrollToBeginning=function(){var scroller=this.scroller;scroller&&scroller.scrollToBeginning()},BaseTab.prototype.loadTemplate=function(){return Promise.resolve()},BaseTab.prototype.onTemplateLoaded=function(){this.scroller||(this.scroller=this.view.querySelector(".scrollFrameY")),this.view.classList.add("focuscontainer-x"),this.scroller&&(this.scroller.classList.add("focuscontainer-y","navout-up"),this.scroller.getNavOutDestination=getScrollerNavOutDestination)},BaseTab.prototype.getApiClient=function(){var _this$options;return this.apiClient||((_this$options=this.params.serverId||(null==(_this$options=this.options)?void 0:_this$options.serverId))?_connectionmanager.default.getApiClient(_this$options):_connectionmanager.default.currentApiClient())},BaseTab.prototype.onBeginResume=function(options){this.paused=!1;var scroller=this.scroller;scroller&&scroller.beginResume&&scroller.beginResume(options)},BaseTab.prototype.onResume=function(options){this.paused=!1;var scroller=this.scroller;scroller&&scroller.resume&&scroller.resume(options),this.supportsFocusPreview()&&(scroller=this.enableFocusPreview(),this.scroller.setHeaderBindingEnabled(!scroller),options=this.scroller.querySelector(".padded-top-page"),scroller?(this.scroller.classList.add("tab-scroller-withfocuspreview"),options&&options.classList.add("tab-scroller-withfocuspreview-padded-top-page"),backgroundContainer.classList.add("backgroundContainer-withfocuspreview"),backdropContainer.classList.add("backdropContainer-withfocuspreview"),this.scroller.setFocusScroll("center")):(this.scroller.classList.remove("tab-scroller-withfocuspreview"),options&&options.classList.remove("tab-scroller-withfocuspreview-padded-top-page"),backgroundContainer.classList.remove("backgroundContainer-withfocuspreview"),backdropContainer.classList.remove("backdropContainer-withfocuspreview"),this._focusPreviewElement&&this.showFocusPreview(null)))},BaseTab.prototype.onPause=function(){this.paused=!0;var scroller=this.scroller;scroller&&scroller.pause&&scroller.pause(),clearSelectedInfoTimer(this),this.supportsFocusPreview()&&(this._focusPreviewElement&&this.showFocusPreview(null),backgroundContainer.classList.remove("backgroundContainer-withfocuspreview"),backdropContainer.classList.remove("backdropContainer-withfocuspreview"))},BaseTab.prototype.destroy=function(){this.paused=null,this.scroller=null,this.view=null,this.params=null,this.apiClient=null,this._focusedElement=null,this._enableBackdrops=null,this._focusPreviewElement=null,clearSelectedInfoTimer(this)};_exports.default=BaseTab});