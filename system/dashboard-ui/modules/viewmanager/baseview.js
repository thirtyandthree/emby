define(["exports","./../dom.js","./../layoutmanager.js","./../browser.js","./../focusmanager.js","./../maintabsmanager.js","./../common/inputmanager.js","./../navdrawer/navdrawer.js","./viewmanager.js","./../approuter.js","./../emby-apiclient/connectionmanager.js","./../common/usersettings/usersettings.js","./../dialoghelper/dialoghelper.js","./../backdrop/backdrop.js"],function(_exports,_dom,_layoutmanager,_browser,_focusmanager,_maintabsmanager,_inputmanager,_navdrawer,_viewmanager,_approuter,_connectionmanager,_usersettings,_dialoghelper,_backdrop){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;var EnableNativeTransitions=document.startViewTransition,docElem=document.documentElement;var deviceMemory,platform,cores,EnableAnimation=!((cores=navigator.hardwareConcurrency||4)<4||(2400<=(screen.width||screen.availWidth||0)||1400<=(screen.height||screen.availHeight||0))&&cores<6||(deviceMemory=navigator.deviceMemory||2)<2||!CSS.supports("transition","all")||!CSS.supports("transform","scale(1)")||!_dom.default.supportsEventListenerOnce()||!docElem.animate||(platform=(navigator.platform||"").toLowerCase(),"android"===globalThis.appMode&&(cores<4||deviceMemory<2||platform.includes("armv7"))));function onFinished(result){return docElem.classList.remove("back-transition"),Promise.resolve(result)}EnableNativeTransitions&&EnableAnimation&&require(["css!modules/viewmanager/transitions.css"]);var currentRequestId=0;var transition=EnableNativeTransitions?function(detail,newView,oldView,isBack){var newViewClassList;return oldView===newView?Promise.resolve():(newViewClassList=newView.classList,EnableAnimation&&_layoutmanager.default.tv?(_layoutmanager.default.tv&&detail.transition&&newViewClassList.add("view-transition-scale","animatedView"),newView=docElem.classList,newViewClassList.contains("view-transition-scale")||isBack&&oldView.classList.contains("view-transition-scale")?newView.add("transition-scale"):newView.remove("transition-scale"),newViewClassList.contains("animatedView")||isBack&&oldView.classList.contains("animatedView")?document.startViewTransition(onStarted).finished.then(onFinished):(onStarted(),Promise.resolve())):(oldView&&(oldView.classList.add("hide"),oldView.classList.remove("animatedView")),newViewClassList.remove("hide","animatedView"),Promise.resolve()));function onStarted(){oldView&&(oldView.classList.add("hide"),isBack)&&newViewClassList.remove("hide")}}:function(detail,newView,oldView,isBack){return oldView===newView?(newView.classList.remove("backgroundContainer","animatedView-in","animatedView-out","animatedView-top"),Promise.resolve()):EnableAnimation&&_layoutmanager.default.tv&&!_browser.default.android?(newView.classList.add("animatedView","animatedView-fade"),new Promise(function(resolve,reject){var elemForEvents,timeout,transitionRequestId=currentRequestId++,onDone=(oldView&&isBack&&(elemForEvents=oldView,newView.classList.add("animatedView-out","animatedView-top"),newView.classList.remove("hide"),oldView.offsetWidth),elemForEvents||((elemForEvents=newView).classList.add("backgroundContainer","animatedView-in","animatedView-top"),oldView.classList.remove("animatedView-top"),oldView.classList.add("backgroundContainer","animatedView-out"),elemForEvents.offsetWidth),function(e){var target=e?e.target:null;target&&target!==e.currentTarget||elemForEvents.currentRequestId===transitionRequestId&&(target&&(_dom.default.removeEventListener(target,"transitioncancel",onDone,{once:!0,passive:!0}),_dom.default.removeEventListener(target,"transitionend",onDone,{once:!0,passive:!0})),clearTimeout(timeout),oldView!==elemForEvents&&(elemForEvents.classList.remove("backgroundContainer"),!oldView)||(oldView.classList.add("hide"),oldView.classList.remove("backgroundContainer","animatedView-in")),resolve())});_dom.default.addEventListener(elemForEvents,"transitioncancel",onDone,{once:!0,passive:!0}),_dom.default.addEventListener(elemForEvents,"transitionend",onDone,{once:!0,passive:!0}),timeout=setTimeout(onDone,400),elemForEvents.currentRequestId=transitionRequestId,requestAnimationFrame(function(){elemForEvents===oldView?(newView.classList.remove("animatedView-out","animatedView-top"),oldView.classList.add("backgroundContainer","animatedView-in","animatedView-top")):newView.classList.remove("animatedView-in")})})):(oldView&&(oldView.classList.add("hide"),oldView.classList.remove("animatedView","animatedView-fade","backgroundContainer","animatedView-in","animatedView-top","animatedView-out")),newView.classList.remove("hide","animatedView","animatedView-fade","backgroundContainer","animatedView-in","animatedView-top","animatedView-out"),Promise.resolve())};function onViewBeforeShow(e){var resumeOptions={refresh:!e.detail.isRestored},instance=this;instance.transitionPromise=(this.onBeginResume(resumeOptions)||Promise.resolve()).then(function(){return function(instance,e){var previousViewInfo,isBack,newView,viewInfo,detail=e.detail;return instance.getTransitionPromise?instance.getTransitionPromise(detail):(previousViewInfo=detail.previousViewInfo)?(isBack=detail.isBack,newView=instance.view,null!=(instance=detail.params)&&instance.asDialog?(_dialoghelper.default.createDialog({dialog:newView,autoFocus:!1,size:_layoutmanager.default.tv?"fullscreen":"medium-tall"}),viewInfo=e.detail,new Promise(function(resolve,reject){newView.addEventListener("opened",resolve),newView.addEventListener("closing",function(){newView._closedForNavigation||(_viewmanager.default.dispatchViewBeforeHide(viewInfo,previousViewInfo),_viewmanager.default.dispatchViewBeforeShow(previousViewInfo,!0,!0,viewInfo))}),_dialoghelper.default.open(newView).then(function(){newView._closedForNavigation||_viewmanager.default.onViewChange(viewInfo,previousViewInfo,!0,!0)})})):"true"===previousViewInfo.params.asDialog?Promise.resolve():transition(detail,newView,previousViewInfo.view,isBack)):Promise.resolve()}(instance,e)})}function getScrollerNavOutDestination(direction){return direction===_focusmanager.default.directions.up?document.querySelector(".skinHeader"):null}function BaseView(view,params){this.view=view,this.params=params,this.requestedItemFields="BasicSyncInfo,CanDelete",this.scroller="emby-scroller"===view.getAttribute("is")?view:view.querySelector(".viewScroller"),view.addEventListener("viewbeforeshow",onViewBeforeShow.bind(this)),view.addEventListener("viewshow",function(e){var instance=this,resumeOptions={refresh:!e.detail.isRestored};resumeOptions.autoFocus=!e.detail.isRestored,this.transitionPromise.then(function(){instance.onResume(resumeOptions)})}.bind(this)),view.addEventListener("viewbeforehide",function(e){this.onPause({event:e,newViewInfo:null==(e=e.detail)?void 0:e.newViewInfo})}.bind(this)),this.view.classList.add("focuscontainer-x"),this.scroller&&("true"===params.asDialog?this.scroller.classList.add("focuscontainer-y"):this.scroller.classList.add("focuscontainer-y","navout-up"),this.scroller.getNavOutDestination=getScrollerNavOutDestination),this.onInputCommandFn=this.onInputCommand.bind(this);params=this.onInputCommandFn;params&&_inputmanager.default.on(view,params)}function onBackCommand(e){_layoutmanager.default.tv&&this.enableBackMenu&&!e.defaultPrevented&&(_approuter.default.showBackMenu(),e.preventDefault())}function shouldShowLeftNav(e){var _viewManager$currentV;return!1!==(null==(_viewManager$currentV=_viewmanager.default.currentViewInfo())?void 0:_viewManager$currentV.drawer)&&!(null!=(_viewManager$currentV=e.detail)&&null!=(_viewManager$currentV=_viewManager$currentV.originalEvent)&&_viewManager$currentV.repeat||e.target.closest(".itemsViewSettingsContainer"))}function showBackdrop(instance,type,parentId){var apiClient=instance.getApiClient();apiClient&&(instance.backdropItems?_backdrop.default.setBackdrops(instance.backdropItems):function(apiClient,types,parentId){return types={SortBy:"Random",Limit:20,Recursive:!0,IncludeItemTypes:types,ImageTypes:"Backdrop",ParentId:parentId,EnableTotalRecordCount:!1,ImageTypeLimit:1,EnableImageTypes:"Backdrop"},apiClient.getItems(apiClient.getCurrentUserId(),types)}(apiClient,type,parentId).then(function(result){result.Items.length?(result=result.Items,instance.backdropItems=result,_backdrop.default.setBackdrops(result)):_backdrop.default.clear()}))}BaseView.prototype.onWindowInputCommand=function(e){"back"===e.detail.command&&onBackCommand.call(this,e)},BaseView.prototype.onInputCommand=function(e){switch(e.detail.command){case"moveleftedge":"rtl"!==document.dir&&shouldShowLeftNav(e)&&(_navdrawer.default.openIfClosed(!0),e.preventDefault());break;case"moverightedge":"rtl"===document.dir&&shouldShowLeftNav(e)&&(_navdrawer.default.openIfClosed(!0),e.preventDefault());break;case"back":onBackCommand.call(this,e)}},BaseView.prototype.supportsFocusPreview=function(){return!1},BaseView.prototype.enableFocusPreview=function(){return _layoutmanager.default.tv&&this.supportsFocusPreview()&&_usersettings.default.enableHomescreenFocusPreviews()},BaseView.prototype.hasSelectedItemDisplay=function(){return!1},BaseView.prototype.getRequestedImageTypes=function(){var fields="Primary,Backdrop,Thumb";return(this.enableFocusPreview()||this.hasSelectedItemDisplay())&&(fields+=",Logo"),fields},BaseView.prototype.getApiClient=function(){var serverId=this.params.serverId;return serverId?_connectionmanager.default.getApiClient(serverId):_connectionmanager.default.currentApiClient()},BaseView.prototype.getRequestedItemFields=function(){return this.requestedItemFields},BaseView.prototype.autoFocus=function(options){options=Object.assign({skipIfNotEnabled:!0},options);var elem,view=this.view;return view&&(elem=_focusmanager.default.autoFocus(view,options))?elem:(!options.skipIfNotEnabled||_focusmanager.default.isAutoFocusEnabled())&&(elem=_maintabsmanager.default.focus())||null},BaseView.prototype.enableTransitions=function(){return!1},BaseView.prototype.enableWindowInputCommands=function(){return this.enableBackMenu},BaseView.prototype.onBeginResume=function(options){var scroller=this.scroller;scroller&&scroller.beginResume&&scroller.beginResume()},BaseView.prototype.getAutoBackdropItemTypes=function(){return[]},BaseView.prototype.onResume=function(options){this.paused=!1,!this.onWindowInputCommandFn&&this.enableWindowInputCommands()&&(this.onWindowInputCommandFn=this.onWindowInputCommand.bind(this),onWindowInputCommandFn=this.onWindowInputCommandFn)&&_inputmanager.default.on(window,onWindowInputCommandFn);var backdropItemTypes,onWindowInputCommandFn=this.scroller;onWindowInputCommandFn&&onWindowInputCommandFn.resume&&onWindowInputCommandFn.resume(),"true"===(onWindowInputCommandFn=this).params.asDialog||_layoutmanager.default.tv||(backdropItemTypes=onWindowInputCommandFn.getAutoBackdropItemTypes()).length&&_usersettings.default.enableBackdrops()&&showBackdrop(onWindowInputCommandFn,backdropItemTypes,(backdropItemTypes=onWindowInputCommandFn.params)?backdropItemTypes.parentId:null)},BaseView.prototype.onPause=function(options){this.paused=!0,(onWindowInputCommandFn=(instance=this).onWindowInputCommandFn)&&_inputmanager.default.off(window,onWindowInputCommandFn),instance.onWindowInputCommandFn=null;var instance,onWindowInputCommandFn=this.scroller;onWindowInputCommandFn&&onWindowInputCommandFn.pause&&onWindowInputCommandFn.pause()},BaseView.prototype.isDestroyed=function(){return null==this.view},BaseView.prototype.destroy=function(){var view=this.view,onInputCommandFn=this.onInputCommandFn;onInputCommandFn&&view&&_inputmanager.default.off(view,onInputCommandFn),this.onInputCommandFn=null,this.animationSourceElement=null,this.scroller=null,this.view=null,this.params=null,this.paused=null,this.apiClient=null,this.backdropItems=null};_exports.default=BaseView});